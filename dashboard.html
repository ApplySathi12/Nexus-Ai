<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus - Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a1a;
            color: #f0f0f0;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
    </div>
    
    <!-- Main Dashboard Content -->
    <div id="dashboard-content" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <a href="index.html" class="text-3xl font-bold">NEXUS</a>
            <div class="flex items-center space-x-4">
                <span id="user-email" class="text-gray-400"></span>
                <button id="signout-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition text-sm">Sign Out</button>
            </div>
        </header>

        <main>
            <h1 class="text-4xl font-bold mb-8">Your Dashboard</h1>
            
            <!-- Subscription Status Section -->
            <div id="subscription-status" class="glass-card rounded-lg p-6 mb-8">
                <!-- Subscription status will be loaded here by JavaScript -->
            </div>

            <!-- Enrolled Courses Section -->
            <h2 class="text-3xl font-bold mb-6">My Courses</h2>
            <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Enrolled courses will be loaded here by JavaScript -->
            </div>
        </main>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // --- SUPABASE CONFIG ---
        const supabaseUrl = 'https://mmmaqiqtvkjpwtdlqzrt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbWFxaXF0dmtqcHd0ZGxxenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MDI2MzEsImV4cCI6MjA3MjI3ODYzMX0.TNEIIEAPLGSbGkt1sjH7-Ft5V52a5uIjnYN68EtTbtQ';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- DOM ELEMENTS ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const dashboardContent = document.getElementById('dashboard-content');
        const userEmailSpan = document.getElementById('user-email');
        const signOutBtn = document.getElementById('signout-btn');
        const subscriptionStatusDiv = document.getElementById('subscription-status');
        const coursesContainer = document.getElementById('courses-container');

        // --- RENDER FUNCTIONS ---
        const renderSubscription = (profile) => {
            if (profile && profile.subscription_plan) {
                const plan = profile.subscription_plan;
                let content = `
                    <h3 class="text-xl font-semibold mb-2">Subscription Status</h3>
                    <p class="text-3xl font-bold text-green-400">${plan} Plan</p>`;
                if (plan === 'Free') {
                    content += `<button class="mt-4 bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-indigo-700 transition">Upgrade to Pro</button>`;
                }
                subscriptionStatusDiv.innerHTML = content;
            } else {
                 subscriptionStatusDiv.innerHTML = `<p class="text-red-400">Could not load subscription details.</p>`;
            }
        };

        const renderCourses = (enrolledCourses) => {
            coursesContainer.innerHTML = ''; 
            if (enrolledCourses && enrolledCourses.length > 0) {
                enrolledCourses.forEach(item => {
                    const course = item.courses;
                    if(course) {
                        const courseCard = `
                        <div class="glass-card rounded-lg p-6 flex flex-col justify-between">
                            <div>
                                <h4 class="text-xl font-bold mb-2">${course.title}</h4>
                                <p class="text-gray-400 text-sm mb-4">${course.description}</p>
                            </div>
                            <button class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition mt-4">Start Learning</button>
                        </div>`;
                        coursesContainer.innerHTML += courseCard;
                    }
                });
            } else {
                coursesContainer.innerHTML = `<p class="text-gray-400 col-span-full">You are not enrolled in any courses yet.</p>`;
            }
        };

        // --- MAIN LOGIC ---
        const loadDashboard = async (user) => {
            userEmailSpan.textContent = user.email;

            // Fetch profile and courses in parallel for faster loading
            const [profileResponse, coursesResponse] = await Promise.all([
                supabase.from('profiles').select('subscription_plan').eq('id', user.id).single(),
                supabase.from('user_courses').select(`*, courses (title, description)`).eq('user_id', user.id)
            ]);
            
            if(profileResponse.error) console.error('Profile Error:', profileResponse.error);
            renderSubscription(profileResponse.data);

            if(coursesResponse.error) console.error('Courses Error:', coursesResponse.error);
            renderCourses(coursesResponse.data);
            
            loadingSpinner.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
        };

        const checkSession = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadDashboard(session.user);
            } else {
                // FIX: Changed to a relative path that works correctly
                window.location.href = './auth.html';
            }
        };

        checkSession();

        signOutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            // FIX: Changed to a relative path that works correctly
            window.location.href = './index.html';
        });

    </script>
</body>
</html>
